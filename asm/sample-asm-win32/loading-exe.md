Загрузка исполняемого файла (**EXE**) в Windows выполняется поэтапно с использованием различных структур PE (Portable Executable) формата. Вот детальное описание процесса:

---

### **Этапы загрузки EXE-файла Windows-загрузчиком**

#### 1. **Открытие файла и проверка формата**
   - Загрузчик открывает файл и выполняет базовую проверку:
     - Читает первые байты (DOS-заголовок) и проверяет сигнатуру `MZ`.
     - Из DOS-заголовка берёт смещение `e_lfanew` — указатель на PE-заголовок.

   **Используемые структуры:**
   - `IMAGE_DOS_HEADER`
   - `e_lfanew`

#### 2. **Чтение и проверка PE-заголовка**
   - Загрузчик переходит к PE-заголовку (по смещению `e_lfanew`) и проверяет его сигнатуру (`PE\0\0`).
   - Проверяет совместимость архитектуры (`IMAGE_FILE_HEADER.Machine`).
   - Извлекает информацию о входной точке, секциях и других данных.

   **Используемые структуры:**
   - `IMAGE_NT_HEADERS`
     - `Signature`
     - `IMAGE_FILE_HEADER`
     - `IMAGE_OPTIONAL_HEADER`

#### 3. **Выделение памяти для образа**
   - Загрузчик резервирует виртуальное адресное пространство для загрузки файла.
     - Размер области определяется полем `SizeOfImage` из `IMAGE_OPTIONAL_HEADER`.
   - Устанавливает базовый адрес загрузки из поля `ImageBase`.
     - Если указанный базовый адрес уже занят, выполняется **релокация** (корректировка ссылок в коде и данных).

   **Используемые структуры:**
   - `IMAGE_OPTIONAL_HEADER`
     - `SizeOfImage`
     - `ImageBase`

#### 4. **Копирование заголовков**
   - Заголовки PE-файла копируются в выделенную память.
   - Область для заголовков определяется полем `SizeOfHeaders`.

   **Используемые структуры:**
   - `IMAGE_OPTIONAL_HEADER`
     - `SizeOfHeaders`

#### 5. **Копирование секций в память**
   - Секции файла (определённые в `Section Table`) копируются в виртуальную память:
     - Каждая секция загружается в соответствии с её `VirtualAddress` и `SizeOfRawData`.
     - Секции выравниваются по границам, заданным в `Section Alignment`.

   **Используемые структуры:**
   - `IMAGE_SECTION_HEADER`
     - `Name` (например, `.text`, `.data`, `.rdata` и др.)
     - `VirtualAddress`
     - `SizeOfRawData`
     - `Characteristics`

#### 6. **Обработка таблицы импорта**
   - Загрузчик находит `Import Directory` через Data Directory.
   - Для каждой импортируемой DLL:
     1. Загрузчик загружает библиотеку (если она ещё не загружена).
     2. Определяет адреса импортируемых функций.
     3. Записывает эти адреса в Import Address Table (IAT).

   **Используемые структуры:**
   - `IMAGE_OPTIONAL_HEADER.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT]`
   - `IMAGE_IMPORT_DESCRIPTOR`
   - Import Address Table (IAT)

#### 7. **Обработка таблицы релокаций (если требуется)**
   - Если базовый адрес (`ImageBase`) файла занят, выполняется релокация:
     - Загрузчик использует таблицу Base Relocation Table для корректировки всех относительных адресов.

   **Используемые структуры:**
   - `IMAGE_OPTIONAL_HEADER.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC]`
   - Base Relocation Table

#### 8. **Обработка других таблиц**
   - Обрабатываются другие таблицы из Data Directory, если они используются:
     - Таблица ресурсов (`IMAGE_DIRECTORY_ENTRY_RESOURCE`).
     - Таблица экспорта (`IMAGE_DIRECTORY_ENTRY_EXPORT`).
     - Таблица исключений, конфигурации и т.д.

   **Используемые структуры:**
   - `IMAGE_OPTIONAL_HEADER.DataDirectory`

#### 9. **Инициализация памяти и кучи**
   - Устанавливаются начальные размеры стека и кучи:
     - Параметры берутся из полей `SizeOfStackReserve`, `SizeOfHeapReserve` и других.

   **Используемые структуры:**
   - `IMAGE_OPTIONAL_HEADER`
     - `SizeOfStackReserve`
     - `SizeOfHeapReserve`

#### 10. **Передача управления точке входа**
   - Загрузчик извлекает адрес точки входа из поля `AddressOfEntryPoint`.
   - Управление передаётся программе:
     - Адрес точки входа вычисляется как:  
       ```
       EntryPoint = ImageBase + AddressOfEntryPoint
       ```

   **Используемые структуры:**
   - `IMAGE_OPTIONAL_HEADER`
     - `AddressOfEntryPoint`

---

### **Краткая последовательность структур PE:**

1. **DOS-заголовок:**  
   - `IMAGE_DOS_HEADER` (`MZ`, `e_lfanew`).

2. **PE-заголовок:**  
   - `IMAGE_NT_HEADERS` (содержит общую информацию о файле).

3. **Секции:**  
   - `IMAGE_SECTION_HEADER` (определяет расположение и тип секций).

4. **Data Directory:**  
   - Указатели на таблицы импорта, экспорта, релокаций и т.д.

---

### **Итоговый процесс загрузки:**

1. Проверка заголовков (DOS и PE).  
2. Резервирование памяти под образ.  
3. Копирование заголовков и секций.  
4. Инициализация импортов и таблиц.  
5. Выполнение релокаций (если требуется).  
6. Настройка стека, кучи и других ресурсов.  
7. Передача управления точке входа.

Если нужна детализация какого-либо этапа или конкретный пример работы с PE-файлом, уточните!